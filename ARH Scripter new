-- Paths
local passFile           = "/sdcard/.ulog_craft"
local expiredDevicesFile = "/sdcard/.vutlenot"
local savedNameFile      = "/sdcard/.jarnogipa"   -- untuk menyimpan username jika belum ada

-- 🔑 Expired code
local expiredCode   = "ARHPremiumTS-2025"
-- 📅 Expire date untuk expiredCode
local expireDate50  = "2025-09-25"

-- Hash helper
local function hash(str)
    local h = 0
    for i = 1, #str do
        h = (h * 31 + str:byte(i)) % 1000000007
    end
    return tostring(h)
end

-- Ambil device info sederhana untuk membuat ID unik
local function getDeviceID()
    local info = gg.getTargetInfo() or {}
    local label = info.label or "unknown"
    local ver   = tostring(info.versionCode or "")
    local host  = os.getenv("HOSTNAME") or ""
    return label .. "-" .. ver .. "-" .. host
end

-- Generate deterministic permanent code berdasarkan device + username
local function generatePermanentCodeDeterministic(username)
    local raw = getDeviceID() .. "|" .. (username or "")
    local h = hash(raw)
    local num = 0
    for i = 1, #h do
        local digit = tonumber(h:sub(i,i)) or 0
        num = (num * 10 + digit) % 1000000
    end
    local six = tostring(num)
    while #six < 6 do six = "0" .. six end
    return "ARHPremium-" .. six
end

-- 📅 Cek tanggal expired (untuk expiredCode)
local function isExpiredDate50()
    local today = os.date("%Y-%m-%d")
    return today > expireDate50
end

-- 🕒 Hitung sisa hari expired
local function getDaysLeft(expDate)
    local y, m, d = expDate:match("(%d+)-(%d+)-(%d+)")
    local target = os.time{year=tonumber(y), month=tonumber(m), day=tonumber(d), hour=23, min=59, sec=59}
    local now = os.time()
    local diff = math.floor((target - now) / (24*60*60))
    if diff < 0 then diff = 0 end
    return diff
end

-- Ambil atau minta username (disimpan ke savedNameFile)
local function getUsername()
    local f = io.open(savedNameFile, "r")
    local uname = nil
    if f then
        uname = f:read("*a")
        f:close()
        if uname then uname = uname:gsub("%s+$", "") end
    end
    if not uname or uname == "" then
        local input = gg.prompt({"Masukkan nama pengguna:"}, {""}, {"text"})
        if not input then gg.alert("❌ Cancelled") os.exit() end
        uname = input[1] or ""
        local fw = io.open(savedNameFile, "w")
        if fw then fw:write(uname) fw:close() end
    end
    return uname
end

-- Ambil permanentCode (HANYA generate deterministik, tidak pakai file)
local username = getUsername()
local permanentCode = generatePermanentCodeDeterministic(username)
local expectedHash = hash(permanentCode)

-- 🔍 Load daftar device permanent
local permanentDevices = {}
local pf = io.open(passFile, "r")
if pf then
    for line in pf:lines() do
        local l = line:gsub("%s+$","")
        if l ~= "" then permanentDevices[#permanentDevices + 1] = l end
    end
    pf:close()
end

local function isPermanentDeviceRegistered(idHash)
    for _, h in ipairs(permanentDevices) do
        if h == idHash then return true end
    end
    return false
end

-- 🔍 Load daftar device expired
local expiredDevices = {}
local ef = io.open(expiredDevicesFile, "r")
if ef then
    for line in ef:lines() do
        local l = line:gsub("%s+$","")
        if l ~= "" then expiredDevices[#expiredDevices+1] = l end
    end
    ef:close()
end

local function isExpiredDeviceRegistered(id)
    for _, d in ipairs(expiredDevices) do
        if d == id then return true end
    end
    return false
end

-- 📌 Alert login info
local function showLoginInfo(mode)
    local now = os.date("%Y-%m-%d %H:%M:%S")
    local expDate = expireDate50
    local header, message

    if mode == "Permanent Code" then  
        header = "✅ Permanent Login Success"  
        message = string.format("%s\n\n📅 Login: %s\n🔑 Type: %s",
            header, now, mode)  

    elseif mode == "Expired Code" then  
        local daysLeft = getDaysLeft(expDate)  
        local leftText = (daysLeft == 1) and "1 day left" or (daysLeft .. " days left")  
        header = "✅ Expired Login Success"  
        message = string.format("%s\n\n📅 Login: %s\n⏳ Expire Date: %s\n⏳ %s\n🔑 Type: %s",
            header, now, expDate, leftText, mode)  
    end  

    gg.alert(message)
end

-- 🔐 Status login
local loginOK = false

-- ✅ Auto-login permanent code (device sudah tercatat)
if isPermanentDeviceRegistered(expectedHash) then
    gg.toast("✅ Auto-login success (Permanent Code)")
    loginOK = true
end

-- ✅ Auto-login expired code (cek expired list dan tanggal)
if not loginOK and isExpiredDeviceRegistered(expiredCode) then
    if isExpiredDate50() then
        gg.alert("⛔ Expired code expired on " .. expireDate50 .. "\n\nPlease use a Permanent Code to continue.")
    else
        gg.toast("✅ Auto-login success (Expired Code)")
        loginOK = true
    end
end

-- 🔑 Kalau belum ada auto-login, minta kode manual
while not loginOK do
    local input = gg.prompt({"🔐 Enter Code"}, {""}, {"text"})
    if not input then gg.alert("❌ Cancelled") os.exit() end
    local code = (input[1] or ""):gsub("^%s+", ""):gsub("%s+$", "")

    if code == permanentCode then  
        if not isPermanentDeviceRegistered(expectedHash) then  
            local pfw = io.open(passFile, "a")  
            if pfw then pfw:write(expectedHash .. "\n") pfw:close() end  
            permanentDevices[#permanentDevices + 1] = expectedHash  
        end  
        gg.toast("✅ Access granted with Permanent Code")  
        showLoginInfo("Permanent Code")  
        loginOK = true  

    elseif code == expiredCode then  
        if isExpiredDate50() then  
            gg.alert("⛔ Expired code expired on " .. expireDate50 .. "\n\nPlease use a Permanent Code to continue.")  
        else  
            if not isExpiredDeviceRegistered(expiredCode) then  
                local efw = io.open(expiredDevicesFile, "a")  
                if efw then efw:write(expiredCode .. "\n") efw:close() end  
                expiredDevices[#expiredDevices+1] = expiredCode  
            end  
            gg.toast("✅ Access granted with Expired Code")  
            showLoginInfo("Expired Code")  
            loginOK = true  
        end  
    else  
        gg.alert("❌ Invalid code, please try again")  
    end
end
