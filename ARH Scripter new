-- ðŸ“ Lokasi file
local passFile           = "/sdcard/Android/media/.syscfg_u1"
local permCodeFile       = "/sdcard/Android/media/.bin_xv"
local expiredDevicesFile = "/sdcard/Android/media/.tmp_87g"

-- âš™ï¸ KONFIGURASI EXPIRED USER (UBAH BAGIAN INI SAJA)
local expiredUserID = 100                         -- ðŸ”¢ Ganti: 20, 30, 40, 50, dst
local expiredCode   = "ARHPremiumTS-2025"        -- ðŸ”‘ Kode expired
local expireDate    = "2025-11-10"               -- ðŸ“… Ganti tanggal kadaluarsa

-- ============================ JANGAN UBAH DI BAWAH INI ============================ --

-- ðŸ”’ Hash helper
local function hash(str)
    local h = 0
    for i = 1, #str do
        h = (h * 31 + str:byte(i)) % 1000000007
    end
    return tostring(h)
end

-- ðŸ“… Cek apakah expired (pakai waktu Unix agar akurat)
local function isExpiredDate()
    local y, m, d = expireDate:match("(%d+)-(%d+)-(%d+)")
    local exp = os.time{year=tonumber(y), month=tonumber(m), day=tonumber(d), hour=23, min=59, sec=59}
    local now = os.time()
    return now > exp
end

-- ðŸ•’ Hitung sisa atau lewat hari
local function getDaysLeft(expDate)
    local y, m, d = expDate:match("(%d+)-(%d+)-(%d+)")
    local target = os.time{year=tonumber(y), month=tonumber(m), day=tonumber(d), hour=23, min=59, sec=59}
    local now = os.time()
    local diff = math.floor((target - now) / (24*60*60))
    return diff
end

-- ðŸ“‚ Ambil permanent code
local f = io.open(permCodeFile, "r")
local permanentCode = f and f:read("*a") or nil
if f then f:close() end

if not permanentCode then
    gg.alert("âŒ Permanent code not found. Please re-run main script.")
    resetMode()
    os.exit()
end

local expectedHash = hash(permanentCode)

-- ðŸ” Load daftar device permanent
local permanentDevices = {}
local pf = io.open(passFile, "r")
if pf then
    for line in pf:lines() do
        permanentDevices[#permanentDevices + 1] = line
    end
    pf:close()
end

local function isPermanentDeviceRegistered(idHash)
    for _, h in ipairs(permanentDevices) do
        if h == idHash then return true end
    end
    return false
end

-- ðŸ” Load daftar device expired
local expiredDevices = {}
local ef = io.open(expiredDevicesFile, "r")
if ef then
    for line in ef:lines() do
        expiredDevices[#expiredDevices+1] = line
    end
    ef:close()
end

local function isExpiredDeviceRegistered(id)
    for _, d in ipairs(expiredDevices) do
        if d == id then return true end
    end
    return false
end

-- ðŸ“Œ Alert login info + auto notifikasi sisa hari
local function showLoginInfo(mode)
    local now = os.date("%Y-%m-%d %H:%M:%S")
    local expDate = expireDate
    local header, message

    if mode == "Permanent Code" then  
        header = "âœ… Permanent Login Success"  
        message = string.format("%s\n\nðŸ“… Login: %s\nðŸ”‘ Type: %s",
            header, now, mode)  

    elseif mode == "Expired Code" then  
        local daysLeft = getDaysLeft(expDate)  
        local leftText
        if daysLeft > 0 then
            leftText = string.format("â³ %d day%s left", daysLeft, daysLeft ~= 1 and "s" or "")
        elseif daysLeft == 0 then
            leftText = "âš ï¸ Expiring today!"
        else
            leftText = string.format("âŒ Expired %d day%s ago", math.abs(daysLeft), math.abs(daysLeft) ~= 1 and "s" or "")
        end

        header = "âœ… Expired Login Success"  
        message = string.format("%s\n\nðŸ“… Login: %s\nâ³ Expire Date: %s\n%s\nðŸ”‘ Type: %s (User %d)",
            header, now, expDate, leftText, mode, expiredUserID)  

        -- ðŸ”” Tambahan notifikasi otomatis sisa hari
        if daysLeft > 0 and daysLeft <= 3 then
            gg.toast("âš ï¸ Your access will expire in " .. daysLeft .. " day" .. (daysLeft ~= 1 and "s" or ""))
        elseif daysLeft == 0 then
            gg.toast("âš ï¸ Your code expires today!")
        elseif daysLeft < 0 then
            gg.toast("âŒ Your code is already expired.")
        end
    end  

    gg.alert(message)
end

-- ðŸ” Status login
local loginOK = false

-- âœ… Auto-login permanent code
if isPermanentDeviceRegistered(expectedHash) then
    loginOK = true
end

-- âœ… Auto-login expired code
if not loginOK and isExpiredDeviceRegistered(expiredCode) then
    if isExpiredDate() then
        local daysOver = math.abs(getDaysLeft(expireDate))
        gg.alert("â›” Expired code expired on " .. expireDate ..
                 string.format("\n\nðŸ“… Overdue: %d day%s\nPlease use a Permanent Code to continue.",
                 daysOver, daysOver ~= 1 and "s" or ""))
    else
        loginOK = true
        local sisa = getDaysLeft(expireDate)
        if sisa <= 3 then
            gg.toast("âš ï¸ Your access will expire in " .. sisa .. " day" .. (sisa ~= 1 and "s" or ""))
        end
    end
end

-- ðŸ”‘ Kalau belum ada auto-login, minta kode manual
while not loginOK do
    local input = gg.prompt({"ðŸ” Enter Code"}, {""}, {"text"})
    if not input then gg.alert("âŒ Cancelled") resetMode() os.exit() end
    local code = input[1]

    if code == permanentCode then  
        if not isPermanentDeviceRegistered(expectedHash) then  
            local pfw = io.open(passFile, "a")  
            if pfw then pfw:write(expectedHash .. "\n") pfw:close() end  
            permanentDevices[#permanentDevices + 1] = expectedHash  
        end    
        showLoginInfo("Permanent Code")  
        loginOK = true  

    elseif code == expiredCode then  
        if isExpiredDate() then  
            local daysOver = math.abs(getDaysLeft(expireDate))
            gg.alert("â›” Expired code expired on " .. expireDate ..
                     string.format("\n\nðŸ“… Overdue: %d day%s\nPlease use a Permanent Code to continue.",
                     daysOver, daysOver ~= 1 and "s" or ""))
        else  
            if not isExpiredDeviceRegistered(expiredCode) then  
                local efw = io.open(expiredDevicesFile, "a")  
                if efw then efw:write(expiredCode .. "\n") efw:close() end  
                expiredDevices[#expiredDevices+1] = expiredCode  
            end  
            showLoginInfo("Expired Code")  
            loginOK = true  
        end  
    else  
        gg.alert("âŒ Invalid code, please try again")  
    end  
end
