-- file: login_combined.lua
local passFile           = "/sdcard/.ulog_craft"
local permCodeFile       = "/sdcard/.brush_viu" -- TIDAK DIGUNAKAN: kita generate deterministik
local expiredDevicesFile = "/sdcard/.vutlenot"

-- ðŸ”‘ Expired code
local expiredCode   = "ARHPremiumTS-2025"
-- ðŸ“… Expire date untuk expiredCode
local expireDate50  = "2025-09-25"

-- Hash helper (sama)
local function hash(str)
    local h = 0
    for i = 1, #str do
        h = (h * 31 + str:byte(i)) % 1000000007
    end
    return tostring(h)
end

-- -----------------------
-- Device & License utils
-- -----------------------
local function getDeviceID()
  local info = gg.getTargetInfo() or {}
  -- beberapa field yang mungkin tersedia; gabungkan menjadi string unik
  local label = info.label or "unknownLabel"
  local vcode = info.versionCode or "0"
  local hostname = os.getenv("HOSTNAME") or "unknownHost"
  local file = gg.getFile() or "unknownFile"
  return label .. "-" .. tostring(vcode) .. "-" .. hostname .. "-" .. file
end

local function generatePermanentCode()
  -- kode berbentuk ARHPremium-xxxxxx deterministik dari device+script
  local seed = getDeviceID()
  local h = tonumber(hash(seed)) or 0
  local num = h % 1000000
  return "ARHPremium-" .. string.format("%06d", num)
end

-- ðŸ“… Cek tanggal expired (untuk expiredCode)
local function isExpiredDate50()
    local today = os.date("%Y-%m-%d")
    return today > expireDate50
end

-- ðŸ•’ Hitung sisa hari expired
local function getDaysLeft(expDate)
    local y, m, d = expDate:match("(%d+)-(%d+)-(%d+)")
    local target = os.time{year=tonumber(y), month=tonumber(m), day=tonumber(d), hour=23, min=59, sec=59}
    local now = os.time()
    local diff = math.floor((target - now) / (24*60*60))
    if diff < 0 then diff = 0 end
    return diff
end

-- -----------------------
-- Ambil / generate permanent code (TIDAK DI-SAVE)
-- -----------------------
local permanentCode = generatePermanentCode()
-- Jika kamu pernah menyimpan file dan mau override manual, kamu bisa uncomment block ini.
--[[
local f = io.open(permCodeFile, "r")
if f then
  local fileCode = f:read("*a")
  f:close()
  if fileCode and fileCode ~= "" then
    -- optional: gunakan file jika ingin (saat ini tidak digunakan sesuai permintaan)
    -- permanentCode = fileCode
  end
end
]]

local expectedHash = hash(permanentCode)

-- ðŸ“‚ Ambil daftar device permanent
local permanentDevices = {}
local pf = io.open(passFile, "r")
if pf then
    for line in pf:lines() do
        permanentDevices[#permanentDevices + 1] = line
    end
    pf:close()
end

local function isPermanentDeviceRegistered(idHash)
    for _, h in ipairs(permanentDevices) do
        if h == idHash then return true end
    end
    return false
end

-- ðŸ” Load daftar device expired
local expiredDevices = {}
local ef = io.open(expiredDevicesFile, "r")
if ef then
    for line in ef:lines() do
        expiredDevices[#expiredDevices+1] = line
    end
    ef:close()
end

local function isExpiredDeviceRegistered(id)
    for _, d in ipairs(expiredDevices) do
        if d == id then return true end
    end
    return false
end

-- ðŸ“Œ Alert login info
local function showLoginInfo(mode)
    local now = os.date("%Y-%m-%d %H:%M:%S")
    local expDate = expireDate50
    local header, message

    if mode == "Permanent Code" then  
        header = "âœ… Permanent Login Success"  
        message = string.format("%s\n\nðŸ“… Login: %s\nðŸ”‘ Type: %s",
            header, now, mode)  

    elseif mode == "Expired Code" then  
        local daysLeft = getDaysLeft(expDate)  
        local leftText = (daysLeft == 1) and "1 day left" or (daysLeft .. " days left")  
        header = "âœ… Expired Login Success"  
        message = string.format("%s\n\nðŸ“… Login: %s\nâ³ Expire Date: %s\nâ³ %s\nðŸ”‘ Type: %s",
            header, now, expDate, leftText, mode)  
    end  

    gg.alert(message)
end

-- ðŸ” Status login
local loginOK = false

-- âœ… Auto-login permanent code
if isPermanentDeviceRegistered(expectedHash) then
    gg.toast("âœ… Auto-login success (Permanent Code)")
    loginOK = true
end

-- âœ… Auto-login expired code
if not loginOK and isExpiredDeviceRegistered(expiredCode) then
    if isExpiredDate50() then
        gg.alert("â›” Expired code expired on " .. expireDate50 .. "\n\nPlease use a Permanent Code to continue.")
    else
        gg.toast("âœ… Auto-login success (Expired Code)")
        loginOK = true
    end
end

-- -----------------------
-- Kalau belum ada auto-login, minta kode manual
-- -----------------------
while not loginOK do
    local input = gg.prompt({"ðŸ” Enter Code"}, {""}, {"text"})
    if not input then gg.alert("âŒ Cancelled") 
        -- resetMode() -- pastikan fungsi ini ada di script utama; jika tidak, comment/implement
        os.exit()
    end
    local code = input[1]

    if code == permanentCode then  
        if not isPermanentDeviceRegistered(expectedHash) then  
            local pfw = io.open(passFile, "a")  
            if pfw then pfw:write(expectedHash .. "\n") pfw:close() end  
            permanentDevices[#permanentDevices + 1] = expectedHash  
        end  
        gg.toast("âœ… Access granted with Permanent Code")  
        showLoginInfo("Permanent Code")  
        loginOK = true  

    elseif code == expiredCode then  
        if isExpiredDate50() then  
            gg.alert("â›” Expired code expired on " .. expireDate50 .. "\n\nPlease use a Permanent Code to continue.")  
        else  
            if not isExpiredDeviceRegistered(expiredCode) then  
                local efw = io.open(expiredDevicesFile, "a")  
                if efw then efw:write(expiredCode .. "\n") efw:close() end  
                expiredDevices[#expiredDevices+1] = expiredCode  
            end  
            gg.toast("âœ… Access granted with Expired Code")  
            showLoginInfo("Expired Code")  
            loginOK = true  
        end  
    else  
        gg.alert("âŒ Invalid code, please try again")  
    end
end

-- lanjutkan eksekusi script (loginOK == true)
